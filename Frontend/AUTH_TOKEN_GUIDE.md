# Access Token Management - Complete Setup

## Overview
The access token is now automatically included in **all GraphQL requests** throughout your application. You don't need to manually add it to each request.

## What Was Changed

### 1. Backend Updates

#### `auth-response.dto.ts`
- Added `user` field to return user data along with the token
```typescript
@Field(() => UserGql)
user: UserGql;
```

#### `user.service.ts`
- Updated `signIn()` method to return the user object
```typescript
return { accessToken: token, expiresIn, user };
```

### 2. Frontend Updates

#### New Files Created:

**`utils/authToken.ts`** - Token Management Utility
- `AuthTokenManager.setToken(token, expiresIn)` - Store token
- `AuthTokenManager.getToken()` - Get token (returns null if expired)
- `AuthTokenManager.clearToken()` - Remove token
- `AuthTokenManager.getAuthHeader()` - Get "Bearer {token}" header
- `AuthTokenManager.isTokenExpired()` - Check if token is expired

**`graphql/client.ts`** - Updated
- **Automatically includes** the Authorization header in all requests
- No manual token handling needed!

**`graphql/userService.ts`** - User API Service
- Type-safe methods for user operations
- `createUser()`, `signIn()`, `getUser()`, `getAllUsers()`

**`graphql/userQueries.ts`** - GraphQL Queries
- All GraphQL query and mutation strings
- Includes `CREATE_USER`, `SIGN_IN`, etc.

**`context/AppContext.tsx`** - Updated
- `login()` - Now stores token using `AuthTokenManager`
- `logout()` - Clears token using `AuthTokenManager`
- `register()` - Creates user via federation gateway

## How It Works

### Registration Flow
```typescript
// User fills registration form
register(name, email, password)
  ↓
userService.createUser({ userId: email, password, role: 'user' })
  ↓
GraphQL mutation sent to http://localhost:4000/graphql
  ↓
Federation gateway → login-sdk subgraph
  ↓
User created in database
  ↓
User object returned and stored in app state
```

### Login Flow
```typescript
// User fills login form
login(email, password)
  ↓
userService.signIn(email, password)
  ↓
GraphQL mutation sent to http://localhost:4000/graphql
  ↓
Backend validates credentials
  ↓
Returns: { accessToken, expiresIn, user }
  ↓
AuthTokenManager.setToken() stores token in localStorage
  ↓
User object stored in app state
```

### Authenticated Requests
```typescript
// ANY GraphQL request automatically includes the token!
graphqlClient.query(GET_USER, { id: 123 })
  ↓
GraphQLClient automatically adds:
  headers: {
    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
  }
  ↓
Request sent with authentication
```

## Usage Examples

### Example 1: Making Any GraphQL Request (Token Auto-Included)
```typescript
import { graphqlClient } from './graphql/client';

// The token is AUTOMATICALLY included - you don't need to do anything!
const data = await graphqlClient.query(`
  query GetProducts {
    products {
      id
      name
      price
    }
  }
`);
```

### Example 2: Check if User is Authenticated
```typescript
import { AuthTokenManager } from './utils/authToken';

if (AuthTokenManager.getToken()) {
  console.log('User is authenticated');
} else {
  console.log('User is not authenticated');
}
```

### Example 3: Protected Route Component
```typescript
import { AuthTokenManager } from '../utils/authToken';
import { Navigate } from 'react-router-dom';

const ProtectedRoute = ({ children }) => {
  if (!AuthTokenManager.getToken()) {
    return <Navigate to="/login" />;
  }
  return children;
};
```

### Example 4: API Call Anywhere in Your App
```typescript
import { graphqlClient } from '../graphql/client';

export async function fetchOrderHistory(userId: number) {
  // Token is automatically included!
  const query = `
    query GetOrders($userId: Int!) {
      orders(userId: $userId) {
        id
        total
        status
      }
    }
  `;
  
  const data = await graphqlClient.query(query, { userId });
  return data.orders;
}
```

## Token Lifecycle

1. **User Logs In**
   - Token is generated by backend
   - Stored in localStorage by `AuthTokenManager.setToken()`
   - Expiry time is calculated and stored

2. **User Makes Requests**
   - `GraphQLClient` automatically includes token in Authorization header
   - Backend validates the token

3. **Token Expires**
   - `AuthTokenManager.getToken()` checks expiry
   - Returns `null` if expired
   - User needs to log in again

4. **User Logs Out**
   - `AuthTokenManager.clearToken()` removes token
   - User state is cleared

## Backend Ports

- **login-sdk** (User Service): `http://localhost:3000`
- **federation_gateway**: `http://localhost:4000/graphql`

## Starting the Services

```bash
# Terminal 1 - Login SDK
cd backend/login-sdk
npm run start:dev

# Terminal 2 - Federation Gateway
cd backend/federation_gateway
npm run start:dev

# Terminal 3 - Frontend
cd Frontend
npm run dev
```

## Security Notes

⚠️ **Important:**
- The token is stored in `localStorage` (visible to any JS code)
- For production, consider using `httpOnly` cookies
- Always use HTTPS in production
- The JWT_SECRET should be strong and environment-specific
- Token expiry is set to 3600 seconds (1 hour) by default

## Testing

1. **Register a new user**
   - Go to `/register`
   - Fill in the form
   - Check localStorage for token (should NOT be there yet)

2. **Login**
   - Go to `/login`
   - Enter credentials
   - Check localStorage → `accessToken` should be present
   - Check console → No errors

3. **Make authenticated requests**
   - Navigate to any page
   - GraphQL requests automatically include the token
   - Check Network tab → Request headers should have `Authorization: Bearer ...`

4. **Logout**
   - Click logout
   - Check localStorage → `accessToken` should be removed

## Troubleshooting

**Token not being sent?**
- Check if `AuthTokenManager.getToken()` returns a value
- Check browser console for errors
- Verify localStorage has `accessToken` key

**401 Unauthorized errors?**
- Token might be expired
- Try logging in again
- Check if backend JWT_SECRET matches

**Token not in response?**
- Verify backend is returning `user` object in `AuthResponse`
- Check backend logs
- Verify GraphQL schema matches the query

## Summary

✅ Token is **automatically included** in all GraphQL requests  
✅ Token is **managed centrally** by `AuthTokenManager`  
✅ Token **expiry is checked** automatically  
✅ **No manual token handling** needed in your components  
✅ **Type-safe** user service with proper TypeScript types  
