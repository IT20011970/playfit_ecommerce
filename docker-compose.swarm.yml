version: '3.8'

services:
  # Zookeeper for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s

  # Kafka broker
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_MESSAGE_MAX_BYTES: 200000000
      KAFKA_MAX_REQUEST_SIZE: 200000000
      KAFKA_SOCKET_REQUEST_MAX_BYTES: 200000000
      KAFKA_REPLICA_FETCH_MAX_BYTES: 200000000
      KAFKA_FETCH_MESSAGE_MAX_BYTES: 200000000
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s

  # Kafka UI
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: playfit
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
      DYNAMIC_CONFIG_ENABLED: 'true'
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Kafdrop
  kafdrop:
    image: obsidiandynamics/kafdrop:latest
    ports:
      - "9000:9000"
    environment:
      KAFKA_BROKERCONNECT: kafka:29092
      SCHEMAREGISTRY_CONNECT: http://schema-registry:8081
      JVM_OPTS: "-Xms32M -Xmx64M"
      SERVER_SERVLET_CONTEXTPATH: "/"
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Redis for BullMQ
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - playfit-network
    command: redis-server --appendonly yes
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Postgres database for cart-service
  cart-db:
    image: postgres:16-alpine
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=cart_db
      - POSTGRES_USER=cart_user
      - POSTGRES_PASSWORD=cart_password
    volumes:
      - cart-db-data:/var/lib/postgresql/data
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Postgres database for user-service
  user-db:
    image: postgres:16-alpine
    ports:
      - "5435:5432"
    environment:
      - POSTGRES_DB=user_db
      - POSTGRES_USER=user_user
      - POSTGRES_PASSWORD=user_password
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Postgres database for order-service
  order-db:
    image: postgres:16-alpine
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_DB=order_db
      - POSTGRES_USER=order_user
      - POSTGRES_PASSWORD=order_password
    volumes:
      - order-db-data:/var/lib/postgresql/data
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Postgres database for inventory-service
  inventory-db:
    image: postgres:16-alpine
    ports:
      - "5436:5432"
    environment:
      - POSTGRES_DB=inventory_db
      - POSTGRES_USER=inventory_user
      - POSTGRES_PASSWORD=inventory_password
    volumes:
      - inventory-db-data:/var/lib/postgresql/data
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Postgres database for event-processor
  event-db:
    image: postgres:16-alpine
    ports:
      - "5437:5432"
    environment:
      - POSTGRES_DB=event_db
      - POSTGRES_USER=event_user
      - POSTGRES_PASSWORD=event_password
    volumes:
      - event-db-data:/var/lib/postgresql/data
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # User Service (login-sdk) - 1 replica
  user-service:
    image: playfit-user-service:latest
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=postgresql://user_user:user_password@user-db:5432/user_db
      - DB_SSL=false
      - JWT_SECRET=your_jwt_secret_here
      - LOKI_URL=http://loki:3100
      - JWT_EXPIRES_IN=3600
      - SECRETS_KEY=7065eff517d912fadd83b4e944e9ef3e1d798af8ca0e8690fb8a609ae8d039d6
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Cart Service - 1 replica (can scale to 2)
  cart-service:
    image: playfit-cart-service:latest
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DATABASE_URL=postgresql://cart_user:cart_password@cart-db:5432/cart_db
      - DB_SSL=false
      - KAFKA_BROKERS=kafka:29092
      - LOKI_URL=http://loki:3100
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Order Service - 2 replicas (can scale to 4)
  order-service:
    image: playfit-order-service:latest
    environment:
      - NODE_ENV=production
      - PORT=3003
      - DATABASE_URL=postgresql://order_user:order_password@order-db:5432/order_db
      - INVENTORY_DATABASE_URL=postgresql://inventory_user:inventory_password@inventory-db:5432/inventory_db
      - DB_SSL=false
      - INVENTORY_DB_SSL=false
      - CART_SERVICE_URL=http://cart-service:3002/graphql
      - INVENTORY_SERVICE_URL=http://inventory-service:3004/graphql
      - KAFKA_BROKERS=kafka:29092
      - LOKI_URL=http://loki:3100
    networks:
      - playfit-network
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Inventory Service - 1 replica (can scale to 3)
  inventory-service:
    image: playfit-inventory-service:latest
    environment:
      - NODE_ENV=production
      - PORT=3004
      - DATABASE_URL=postgresql://inventory_user:inventory_password@inventory-db:5432/inventory_db
      - DB_SSL=false
      - KAFKA_BROKERS=kafka:29092
      - LOKI_URL=http://loki:3100
    volumes:
      - inventory-uploads:/app/uploads
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Event Processor - 2 replicas (can scale to 4)
  event-processor:
    image: playfit-event-processor:latest
    environment:
      - NODE_ENV=production
      - PORT=3005
      - EVENT_DB_URL=postgresql://event_user:event_password@event-db:5432/event_db
      - ORDER_DB_URL=postgresql://order_user:order_password@order-db:5432/order_db
      - INVENTORY_DB_URL=postgresql://inventory_user:inventory_password@inventory-db:5432/inventory_db
      - DB_SSL=false
      - KAFKA_BROKERS=kafka:29092
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LOKI_URL=http://loki:3100
    networks:
      - playfit-network
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Notification Service - 1 replica (can scale to 2)
  notification-service:
    image: playfit-notification-service:latest
    ports:
      - "3006:3006"
    environment:
      - NODE_ENV=production
      - PORT=3006
      - KAFKA_BROKERS=kafka:29092
      - CORS_ORIGIN=http://localhost,http://localhost:5173,http://localhost:80,http://host.docker.internal:80,http://host.docker.internal:5173
      - GMAIL_USER=gayanpoornima@gmail.com
      - GMAIL_APP_PASSWORD=amropcmetpxwcfrs
      - LOKI_URL=http://loki:3100
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Federation Gateway - 2 replicas (can scale to 3)
  federation-gateway:
    image: playfit-federation-gateway:latest
    command: sh -c "sleep 60 && node dist/main"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - CORS_ORIGIN=http://localhost:80,http://localhost:5173,http://localhost,http://host.docker.internal:80,http://host.docker.internal:5173
      - ALLOWED_HEADERS=Content-Type,Authorization,Accept
      - USER_SERVICE_URL=http://playfit_user-service:3000/graphql
      - CART_SERVICE_URL=http://playfit_cart-service:3002/graphql
      - ORDER_SERVICE_URL=http://playfit_order-service:3003/graphql
      - INVENTORY_SERVICE_URL=http://playfit_inventory-service:3004/graphql
      - LOKI_URL=http://playfit_loki:3100
    dns:
      - 127.0.0.11
    networks:
      - playfit-network
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Nginx Proxy - Single entry point for all services
  nginx-proxy:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/conf.d/default.conf
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Frontend - 1 replica
  frontend:
    image: playfit-frontend:latest
    environment:
      - VITE_API_URL=/graphql
      - VITE_NOTIFICATION_URL=
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  # Grafana - Observability Platform
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s:%(http_port)s/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Loki - Log Aggregation
  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    volumes:
      - loki-data:/loki
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Tempo - Distributed Tracing
  tempo:
    image: grafana/tempo:latest
    user: "0:0"
    ports:
      - "3200:3200"
      - "4317:4317"
      - "4318:4318"
    volumes:
      - ./tempo/tempo-config.yml:/etc/tempo-config.yml
      - tempo-data:/tmp/tempo
    command: ["--config.file=/etc/tempo-config.yml"]
    networks:
      - playfit-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

networks:
  playfit-network:
    driver: overlay
    attachable: true

volumes:
  cart-db-data:
  user-db-data:
  order-db-data:
  inventory-db-data:
  event-db-data:
  redis-data:
  grafana-data:
  loki-data:
  prometheus-data:
  tempo-data:
  inventory-uploads:
