# Upstream blocks for load balancing
# Docker Swarm resolves service names to all replica IPs via DNS

upstream federation_gateway_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    # least_conn ensures requests go to the server with fewest connections
    least_conn;
    server playfit_federation-gateway:4000 resolve max_fails=3 fail_timeout=30s;
}

upstream inventory_service_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_inventory-service:3004 resolve max_fails=3 fail_timeout=30s;
}

upstream notification_service_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_notification-service:3006 resolve max_fails=3 fail_timeout=30s;
}

upstream order_service_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_order-service:3003 resolve max_fails=3 fail_timeout=30s;
}

upstream cart_service_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_cart-service:3002 resolve max_fails=3 fail_timeout=30s;
}

upstream user_service_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_user-service:3000 resolve max_fails=3 fail_timeout=30s;
}

upstream event_processor_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_event-processor:3005 resolve max_fails=3 fail_timeout=30s;
}

upstream frontend_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_frontend:80 resolve max_fails=3 fail_timeout=30s;
}

upstream kafdrop_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_kafdrop:9000 resolve max_fails=3 fail_timeout=30s;
}

upstream grafana_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_grafana:3000 resolve max_fails=3 fail_timeout=30s;
}

upstream loki_backend {
    resolver 127.0.0.11 valid=30s;
    zone upstreams 64k;
    least_conn;
    server playfit_loki:3100 resolve max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name _;

    # Kafdrop static resources (must come before frontend location)
    location ~ ^/(css|js|images|fonts|webjars)/ {
        proxy_pass http://kafdrop_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Kafdrop topic pages
    location /topic/ {
        proxy_pass http://kafdrop_backend/topic/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend
    location / {
        proxy_pass http://frontend_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Product Images - served from inventory service
    location /uploads/ {
        proxy_pass http://inventory_service_backend/uploads/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Image Upload API
    location /api/images/ {
        proxy_pass http://inventory_service_backend/api/images/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 10M;
    }

    # User Service API
    location /api/user/ {
        proxy_pass http://user_service_backend/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Cart Service API
    location /api/cart/ {
        proxy_pass http://cart_service_backend/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Order Service API
    location /api/order/ {
        proxy_pass http://order_service_backend/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Inventory Service API
    location /api/inventory/ {
        proxy_pass http://inventory_service_backend/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # GraphQL API
    location /graphql {
        proxy_pass http://federation_gateway_backend/graphql;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Notification Service WebSocket - /notifications namespace with Socket.IO path
    location ~ ^/notifications/socket\.io/ {
        proxy_pass http://notification_service_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # Notification Service WebSocket - default Socket.IO path
    location /socket.io/ {
        proxy_pass http://notification_service_backend/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # Grafana - Observability Dashboard
    location /grafana/ {
        proxy_pass http://grafana_backend/grafana/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Kafdrop - Kafka UI (with path rewriting)
    location /kafdrop {
        rewrite ^/kafdrop(/.*)$ $1 break;
        rewrite ^/kafdrop$ / break;
        proxy_pass http://kafdrop_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect ~^/(.*)$ /kafdrop/$1;
    }

    # Loki - Log Aggregation API
    location /loki/ {
        proxy_pass http://loki_backend/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
